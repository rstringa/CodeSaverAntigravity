---
import Layout from "../../layouts/Layout.astro";
import { getSnippetById, getCategories } from "../../lib/data";
import { Save, X } from "@lucide/astro";

const { id } = Astro.params;
const snippet = await getSnippetById(id);
const categories = await getCategories();

if (!snippet) {
    return Astro.redirect("/404");
}

const mainCategories = categories.filter((c) => !c.parentId);
const subCategories = categories.filter((c) => c.parentId);

const categoryOptions = mainCategories.flatMap((parent) => [
    { ...parent, label: parent.name },
    ...subCategories
        .filter((s) => s.parentId === parent.id)
        .map((sub) => ({
            ...sub,
            label: `— ${sub.name}`,
        })),
]);
---

<Layout
    title={`Editar Snippet | CodeSaverAntigravity`}
    activeCategoryId={snippet.categoryId}
>
    <div class="form-container">
        <header class="form-header">
            <h1>Editar Snippet</h1>
            <p>Modifica la información de tu snippet.</p>
        </header>

        <form id="edit-form" class="snippet-form" data-id={id}>
            <div class="form-group">
                <label for="title">Título</label>
                <input
                    type="text"
                    id="title"
                    name="title"
                    value={snippet.title}
                    required
                />
            </div>

            <div class="form-group">
                <label for="categoryId">Categoría</label>
                <select id="categoryId" name="categoryId">
                    {
                        categoryOptions.map((opt) => (
                            <option
                                value={opt.id}
                                selected={opt.id === snippet.categoryId}
                            >
                                {opt.label}
                            </option>
                        ))
                    }
                </select>
            </div>

            <div class="form-group">
                <label for="description">Descripción corta</label>
                <textarea id="description" name="description" rows="3"
                    >{snippet.description}</textarea
                >
            </div>

            <div class="form-group">
                <label for="code">Código o Contenido</label>
                <textarea
                    id="code"
                    name="code"
                    rows="12"
                    class="code-editor"
                    required>{snippet.code}</textarea
                >
            </div>

            <div class="form-footer">
                <button
                    type="button"
                    class="btn-ghost"
                    id="cancel-btn"
                    disabled
                >
                    <X size={18} />
                    <span>Cancelar</span>
                </button>
                <button
                    type="submit"
                    class="btn-primary"
                    id="save-btn"
                    disabled
                >
                    <Save size={18} />
                    <span>Guardar Cambios</span>
                </button>
            </div>
        </form>
    </div>
</Layout>

<style>
    /* ... existing styles ... */
    .form-container {
        max-width: 800px;
        margin: 0 auto;
        padding-bottom: 4rem;
    }

    .form-header {
        margin-bottom: 2.5rem;
    }

    .form-header h1 {
        font-size: 2.25rem;
        margin-bottom: 0.5rem;
    }

    .form-header p {
        color: var(--text-secondary);
    }

    .snippet-form {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-lg);
        padding: 2.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-secondary);
    }

    input,
    textarea,
    select {
        width: 100%;
        background: var(--bg-primary);
        border: 1px solid var(--border-primary);
        padding: 0.75rem 1rem;
        font-size: 1rem;
        color: var(--text-primary);
        border-radius: var(--radius-sm);
    }

    .code-editor {
        font-family:
            ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 0.875rem;
        line-height: 1.5;
        background: #0d0d0d;
        color: #e0e0e0;
        tab-size: 2;
    }

    .form-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-primary);
    }

    .btn-ghost {
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid transparent;
        padding: 0.5rem 1rem;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-ghost:hover:not(:disabled) {
        color: var(--text-primary);
        background: var(--bg-tertiary);
    }

    .btn-primary {
        background: var(--accent);
        color: #000;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary:hover:not(:disabled) {
        background: var(--accent-hover);
    }

    .btn-primary:disabled,
    .btn-ghost:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }
</style>

<script>
    const form = document.getElementById("edit-form") as HTMLFormElement;
    const saveBtn = document.getElementById("save-btn") as HTMLButtonElement;
    const cancelBtn = document.getElementById(
        "cancel-btn",
    ) as HTMLButtonElement;

    if (form && saveBtn && cancelBtn) {
        const id = form.getAttribute("data-id");
        let isDirty = false;

        // Store initial values
        const initialData = new FormData(form);
        const initialState = JSON.stringify(
            Object.fromEntries(initialData.entries()),
        );

        const checkChanges = () => {
            const currentData = new FormData(form);
            const currentState = JSON.stringify(
                Object.fromEntries(currentData.entries()),
            );

            isDirty = initialState !== currentState;
            saveBtn.disabled = !isDirty;
            cancelBtn.disabled = !isDirty;
        };

        form.addEventListener("input", checkChanges);

        // Before leave confirmation
        window.addEventListener("beforeunload", (e) => {
            if (isDirty) {
                e.preventDefault();
                e.returnValue = ""; // Standard way to trigger browser confirmation
            }
        });

        cancelBtn.addEventListener("click", () => {
            if (isDirty) {
                if (
                    confirm(
                        "Tienes cambios sin guardar. ¿Deseas descartarlos y volver?",
                    )
                ) {
                    isDirty = false; // Disable flag to allow navigation
                    window.history.back();
                }
            }
        });

        form.addEventListener("submit", async (e: Event) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`/api/snippets/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    isDirty = false; // Disable flag before redirect
                    window.location.href = `/snippet/${id}`;
                } else {
                    alert("Error al guardar los cambios");
                }
            } catch (err) {
                console.error("Error:", err);
                alert("Error de conexión");
            }
        });
    }
</script>
