---
import { Copy, Trash2, Edit2, Code as CodeIcon } from "@lucide/astro";
import { Code } from "astro:components";

const { snippet } = Astro.props;
---

<article class="snippet-card" data-category-id={snippet.categoryId}>
    <div class="card-header">
        <a href={`/snippet/${snippet.id}`} class="title-link">
            <div class="title-area">
                <CodeIcon size={16} class="text-accent" />
                <h3 class="snippet-title">{snippet.title}</h3>
            </div>
        </a>
        <div class="card-actions">
            <button
                class="icon-btn copy-btn"
                data-code={snippet.code}
                title="Copiar código"
            >
                <Copy size={16} />
            </button>
            <a
                href={`/edit/${snippet.id}`}
                class="icon-btn edit-btn"
                title="Editar"
            >
                <Edit2 size={16} />
            </a>
            <button
                class="icon-btn delete-btn"
                data-id={snippet.id}
                title="Eliminar"
            >
                <Trash2 size={16} />
            </button>
        </div>
    </div>

    {snippet.description && <p class="snippet-desc">{snippet.description}</p>}

    <div class="code-preview">
        <Code code={snippet.code} lang="javascript" theme="github-dark" />
    </div>

    <div class="card-footer">
        <span class="category-tag">{snippet.categoryName || "General"}</span>
        <time class="date-tag"
            >{new Date(snippet.createdAt).toLocaleDateString()}</time
        >
    </div>
</article>

<style is:global>
    .code-preview pre {
        padding: 1rem !important;
        margin: 0 !important;
        background-color: #0d0d0d !important;
        font-size: 0.8rem !important;
        line-height: 1.4 !important;
        border-radius: var(--radius-md) !important;
        border: 1px solid var(--border-primary) !important;
    }
</style>

<style>
    .snippet-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        transition: all 0.2s;
        max-height: 500px;
        overflow: hidden;
    }

    .snippet-card:hover {
        border-color: var(--border-secondary);
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .title-link {
        text-decoration: none;
        color: inherit;
    }

    .title-link:hover .snippet-title {
        color: var(--accent);
        text-decoration: underline;
    }

    .title-area {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .snippet-title {
        font-size: 1.125rem;
        margin: 0;
        transition: color 0.1s;
    }

    .card-actions {
        display: flex;
        gap: 0.5rem;
    }

    .icon-btn {
        background: transparent;
        border: 1px solid var(--border-primary);
        color: var(--text-tertiary);
        padding: 0.4rem;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .icon-btn:hover {
        border-color: var(--text-secondary);
        color: var(--text-primary);
        background: var(--bg-tertiary);
    }

    .copy-btn:hover {
        color: var(--accent);
        border-color: var(--accent);
    }
    .delete-btn:hover {
        color: var(--error);
        border-color: var(--error);
    }

    .snippet-desc {
        color: var(--text-secondary);
        font-size: 0.875rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .code-preview {
        position: relative;
        max-height: 200px;
        overflow: hidden;
        overflow-y: auto;
        mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
    }

    .card-footer {
        margin-top: auto;
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.75rem;
        padding-top: 0.5rem;
    }

    .category-tag {
        background: var(--bg-tertiary);
        color: var(--text-secondary);
        padding: 0.25rem 0.5rem;
        border-radius: var(--radius-sm);
        font-weight: 500;
    }

    .date-tag {
        color: var(--text-tertiary);
    }
</style>

<script>
    // Copy to clipboard functionality
    document.querySelectorAll(".copy-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
            const code = btn.getAttribute("data-code");
            try {
                if (code) {
                    await navigator.clipboard.writeText(code);
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = "✓";
                    btn.classList.add("text-accent");
                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.classList.remove("text-accent");
                    }, 2000);
                }
            } catch (err) {
                console.error("Error al copiar:", err);
            }
        });
    });

    // Delete functionality
    document.querySelectorAll(".delete-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            if (
                confirm("¿Estás seguro de que quieres eliminar este snippet?")
            ) {
                try {
                    const response = await fetch(`/api/snippets/${id}`, {
                        method: "DELETE",
                    });
                    if (response.ok) {
                        window.location.reload();
                    }
                } catch (err) {
                    console.error("Error al eliminar:", err);
                }
            }
        });
    });
</script>
