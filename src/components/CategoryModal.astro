---
import { X } from "@lucide/astro";
---

<div id="category-modal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <h2 id="modal-title">Nueva Categoría</h2>
            <button class="close-btn" id="close-modal">
                <X size={20} />
            </button>
        </div>
        <div class="modal-body">
            <form id="category-form">
                <input type="hidden" id="cat-id" name="id" />
                <input type="hidden" id="cat-parent-id" name="parentId" />
                <div class="form-group">
                    <label for="cat-name">Nombre</label>
                    <input
                        type="text"
                        id="cat-name"
                        name="name"
                        placeholder="Escribe el nombre..."
                        required
                        autocomplete="off"
                    />
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn-secondary"
                        id="cancel-modal"
                    >
                        Cancelar
                    </button>
                    <button
                        type="submit"
                        class="btn-primary"
                        id="save-category"
                    >
                        Guardar
                    </button>
                </div>
            </form>

            <div id="delete-confirm" style="display: none;">
                <p>
                    ¿Estás seguro de que quieres eliminar esta categoría? Los
                    snippets asociados se moverán a "General".
                </p>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn-secondary"
                        id="cancel-delete"
                    >
                        No, cancelar
                    </button>
                    <button
                        type="button"
                        class="btn-danger"
                        id="confirm-delete"
                    >
                        Sí, eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.2s ease-out;
    }

    .modal-overlay.active {
        opacity: 1;
    }

    .modal-container {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-lg);
        width: 100%;
        max-width: 400px;
        box-shadow:
            0 20px 25px -5px rgba(0, 0, 0, 0.5),
            0 10px 10px -5px rgba(0, 0, 0, 0.4);
        transform: translateY(20px);
        transition: transform 0.2s ease-out;
    }

    .modal-overlay.active .modal-container {
        transform: translateY(0);
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border-primary);
    }

    .modal-header h2 {
        font-size: 1.125rem;
        margin: 0;
    }

    .close-btn {
        background: transparent;
        border: none;
        color: var(--text-tertiary);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .close-btn:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .modal-body {
        padding: 1.5rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .form-group label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-secondary);
    }

    .form-group input {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
        border-radius: var(--radius-md);
        background: var(--bg-primary);
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        margin-top: 1.5rem;
    }

    .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-primary);
        padding: 0.625rem 1.25rem;
        border-radius: var(--radius-md);
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-secondary:hover {
        background: var(--border-primary);
    }

    .btn-danger {
        background: var(--error);
        color: white;
        border: none;
        padding: 0.625rem 1.25rem;
        border-radius: var(--radius-md);
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-danger:hover {
        filter: brightness(1.1);
    }

    .btn-primary {
        background: var(--accent);
        color: #000;
        border: none;
        padding: 0.625rem 1.25rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-primary:hover {
        background: var(--accent-hover);
    }

    p {
        color: var(--text-secondary);
        font-size: 0.95rem;
        line-height: 1.5;
    }
</style>

<script is:inline>
    (function () {
        const modal = document.getElementById("category-modal");
        const form = document.getElementById("category-form");
        const deleteConfirm = document.getElementById("delete-confirm");
        const title = document.getElementById("modal-title");
        const closeBtn = document.getElementById("close-modal");
        const cancelBtn = document.getElementById("cancel-modal");
        const cancelDeleteBtn = document.getElementById("cancel-delete");
        const nameInput = document.getElementById("cat-name");
        const idInput = document.getElementById("cat-id");
        const parentIdInput = document.getElementById("cat-parent-id");
        const confirmDeleteBtn = document.getElementById("confirm-delete");

        function openModal(options) {
            const { type, categoryId, categoryName, parentId } = options;

            // Prevent scrolling
            document.body.style.overflow = "hidden";

            // Reset modal state
            modal.style.display = "flex";
            setTimeout(() => modal.classList.add("active"), 10);

            form.style.display = "none";
            deleteConfirm.style.display = "none";

            if (type === "create") {
                title.textContent = parentId
                    ? "Nueva Subcategoría"
                    : "Nueva Categoría";
                form.style.display = "block";
                idInput.value = "";
                parentIdInput.value = parentId || "";
                nameInput.value = "";
                nameInput.focus();
            } else if (type === "edit") {
                title.textContent = "Editar Categoría";
                form.style.display = "block";
                idInput.value = categoryId;
                parentIdInput.value = "";
                nameInput.value = categoryName;
                nameInput.focus();
            } else if (type === "delete") {
                title.textContent = "Eliminar Categoría";
                deleteConfirm.style.display = "block";
                idInput.value = categoryId;
            }
        }

        function closeModal() {
            modal.classList.remove("active");
            document.body.style.overflow = "";
            setTimeout(() => {
                modal.style.display = "none";
            }, 200);
        }

        // Global exposing of openModal
        window.categoryModal = {
            open: openModal,
            close: closeModal,
        };

        [closeBtn, cancelBtn, cancelDeleteBtn].forEach((btn) => {
            btn.addEventListener("click", closeModal);
        });

        modal.addEventListener("click", (e) => {
            if (e.target === modal) closeModal();
        });

        // Form Submission
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const id = idInput.value;
            const name = nameInput.value;
            const parentId = parentIdInput.value;

            try {
                let response;
                if (id) {
                    // Update
                    response = await fetch(`/api/categories/${id}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ name }),
                    });
                } else {
                    // Create
                    response = await fetch("/api/categories", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            name,
                            parentId: parentId || null,
                        }),
                    });
                }

                if (response.ok) {
                    window.location.reload();
                }
            } catch (err) {
                console.error("Error saving category:", err);
            }
        });

        // Delete Confirmation
        confirmDeleteBtn.addEventListener("click", async () => {
            const id = idInput.value;
            try {
                const response = await fetch(`/api/categories/${id}`, {
                    method: "DELETE",
                });
                if (response.ok) {
                    window.location.reload();
                }
            } catch (err) {
                console.error("Error deleting category:", err);
            }
        });
    })();
</script>
