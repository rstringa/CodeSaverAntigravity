---
import "../styles/global.css";
import CategoryList from "../components/CategoryList.astro";
import CategoryModal from "../components/CategoryModal.astro";
import {
    Search,
    Plus,
    Folder,
    LayoutGrid,
    Code,
    ChevronDown,
    ChevronRight,
} from "@lucide/astro";
import { supabase } from "../lib/supabase";
import { LogOut } from "@lucide/astro";

const { title = "CodeSaverAntigravity", activeCategoryId = null } = Astro.props;

// Obtener sesión en el servidor
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const refreshToken = Astro.cookies.get("sb-refresh-token")?.value;
let isAuthenticated = false;

if (accessToken && refreshToken) {
    const { data } = await supabase.auth.setSession({
        access_token: accessToken,
        refresh_token: refreshToken,
    });
    if (data.session) isAuthenticated = true;
}

const isAuthPage =
    Astro.url.pathname === "/login" ||
    Astro.url.pathname === "/register" ||
    Astro.url.pathname === "/";
---

<html lang="es">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <title>{title}</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
    </head>
    <body class={!isAuthenticated || isAuthPage ? "public-view" : ""}>
        <div class="app-container">
            {
                isAuthenticated && !isAuthPage && (
                    <aside class="sidebar">
                        <div class="sidebar-header">
                            <Code size={24} class="text-accent" />
                            <span class="logo-text">CodeSaver</span>
                        </div>
                        <nav class="sidebar-nav">
                            <a href="/dashboard" class="nav-item active">
                                <LayoutGrid size={18} />
                                <span>Dashboard</span>
                            </a>
                            <div class="nav-section">
                                <div class="section-title">Categorías</div>
                                <CategoryList
                                    activeCategoryId={activeCategoryId}
                                />
                            </div>
                        </nav>

                        <div class="sidebar-footer">
                            <button class="add-category-btn w-full">
                                <Plus size={16} />
                                <span>Nueva Categoría</span>
                            </button>
                        </div>
                    </aside>
                )
            }

            <main class="main-content">
                {
                    isAuthenticated && !isAuthPage && (
                        <header class="top-bar">
                            <div class="search-container">
                                <Search size={18} class="search-icon" />
                                <input
                                    type="text"
                                    id="global-search"
                                    placeholder="Buscar snippets..."
                                />
                            </div>
                            <div class="actions">
                                <a
                                    href="/new"
                                    id="add-snippet-btn"
                                    class="btn-primary"
                                >
                                    <Plus size={18} />
                                    <span>Nuevo Snippet</span>
                                </a>
                                <button
                                    id="logout-btn-top"
                                    class="btn-secondary btn-icon-only"
                                    title="Cerrar Sesión"
                                >
                                    <LogOut size={18} />
                                </button>
                            </div>
                        </header>
                    )
                }

                <div class="content-body">
                    <slot />
                </div>
            </main>
        </div>

        <style is:global>
            .public-view .app-container {
                display: block;
            }
            .public-view .main-content {
                height: auto;
                overflow: visible;
            }
            .public-view .content-body {
                padding: 0;
                overflow: visible;
            }

            .logout-item {
                margin-top: 1rem;
                color: var(--text-tertiary) !important;
                border: none;
                background: transparent;
                width: 100%;
                cursor: pointer;
            }
            .logout-item:hover {
                color: var(--error) !important;
            }
            .sidebar-footer {
                margin-top: auto;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            .w-full {
                width: 100%;
            }

            .text-accent {
                color: var(--accent);
            }

            .app-container {
                display: flex;
                height: 100vh;
            }

            .sidebar {
                width: 260px;
                background: var(--bg-secondary);
                border-right: 1px solid var(--border-primary);
                display: flex;
                flex-direction: column;
                padding: 1.5rem 1rem;
            }

            .sidebar-header {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                margin-bottom: 2rem;
                padding-left: 0.5rem;
            }

            .logo-text {
                font-size: 1.25rem;
                font-weight: 700;
                letter-spacing: -0.025em;
            }

            .sidebar-nav {
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                overflow-y: auto;
            }

            .nav-item {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.625rem 0.75rem;
                border-radius: var(--radius-md);
                color: var(--text-secondary);
                transition: all 0.2s;
                font-weight: 500;
                text-decoration: none;
            }

            .nav-item:hover {
                background: var(--bg-tertiary);
                color: var(--text-primary);
            }

            .btn-secondary {
                background: var(--bg-tertiary);
                color: var(--text-secondary);
                border: 1px solid var(--border-primary);
                padding: 0.5rem;
                border-radius: var(--radius-md);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s;
            }

            .btn-secondary:hover {
                background: var(--bg-primary);
                color: var(--error);
                border-color: var(--error);
            }

            .actions {
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            .nav-item.active {
                background: var(--bg-tertiary);
                color: var(--accent);
            }

            .nav-section {
                margin-top: 2rem;
            }

            .section-title {
                font-size: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: var(--text-tertiary);
                margin-bottom: 0.75rem;
                padding-left: 0.75rem;
                font-weight: 700;
            }

            .main-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .top-bar {
                height: 64px;
                border-bottom: 1px solid var(--border-primary);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 2rem;
                background: var(--bg-primary);
            }

            .search-container {
                position: relative;
                flex: 1;
                max-width: 600px;
            }

            .search-icon {
                position: absolute;
                left: 12px;
                top: 50%;
                transform: translateY(-50%);
                color: var(--text-tertiary);
            }

            .search-container input {
                width: 100%;
                padding-left: 40px;
                background: var(--bg-secondary);
                border-color: var(--border-primary);
                height: 40px;
            }

            .btn-primary {
                background: var(--accent);
                color: #000;
                border: none;
                padding: 0.5rem 1rem;
                border-radius: var(--radius-md);
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-weight: 600;
                transition: background 0.2s;
                text-decoration: none;
            }

            .btn-primary:hover {
                background: var(--accent-hover);
            }

            .content-body {
                flex: 1;
                overflow-y: auto;
                padding: 2rem;
            }

            .add-category-btn {
                background: transparent;
                border: 1px dashed var(--border-primary);
                color: var(--text-secondary);
                padding: 0.625rem;
                border-radius: var(--radius-md);
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
                transition: all 0.2s;
                cursor: pointer;
            }

            .add-category-btn:hover {
                border-color: var(--accent);
                color: var(--accent);
                background: rgba(62, 207, 142, 0.05);
            }
        </style>

        {isAuthenticated && <CategoryModal />}

        <script>
            import { supabase } from "../lib/supabase";

            // Logout Logic
            const logoutBtns = ["logout-btn", "logout-btn-top"];
            logoutBtns.forEach((id) => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.addEventListener("click", async () => {
                        await supabase.auth.signOut();
                        await fetch("/api/auth/session", { method: "DELETE" });
                        window.location.href = "/";
                    });
                }
            });

            // Category Modal Logic
            const addCategoryBtn = document.querySelector(".add-category-btn");
            if (addCategoryBtn) {
                addCategoryBtn.addEventListener("click", () => {
                    if ((window as any).categoryModal) {
                        (window as any).categoryModal.open({ type: "create" });
                    }
                });
            }
        </script>
    </body>
</html>
